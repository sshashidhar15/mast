<% setI18nPrefix('pages.help-resources.fsa-migration-help') %>
<link rel="stylesheet" href="<%=md5('/css/pages/help-centre.css')%>">
<meta name="description" content="<%- $t('meta', true) %>">
<%- contentFor('title') %>
  <%- $t('title') %>
<%- contentFor('body') %>

    <div class="single-page page-help-centre">
		<%
		let helpCentre = {
			searchDB: [],
			faqDB: [],
            getFaqDB: function () {
                if (!this.faqDB.length) {
                    this.mountFaqDB();
                }
                return this.faqDB;
            },
			mountFaqDB: function () {
				this.faqDB = [];
				var i, faq, o, l;
				var order = [];
				for (i = 0; i <= 25; i++) {
					faq = {
						o: 0,
						id: 'i_' + i,
						ip: '#i_' + i,
						q: $t('sc_q' + i),
						a: $t('sc_a' + i)
					};
					l = order.length;
					this.faqDB.push(faq);
				}
			},
            getSectionFAQs: function (section) {
                if (!this.faqDB.length) {
                    this.mountFaqDB();
                }
                switch (section) {
                    case 1:
                        return this.faqDB.slice(0, 8);
                        break;
                    case 2:
                        return this.faqDB.slice(8, 14);
                        break;
                    case 3:
                        return this.faqDB.slice(14, 20);
                        break;
                    case 4:
                        return this.faqDB.slice(20, 25);
                        break;
                    case 5:
                        return this.faqDB.slice(25, 26);
                        break;
                }
                return this.faqDB;
            }
		}
		helpCentre.mountFaqDB();
		%>
		<article style="padding-top:140px; padding-bottom:140px;" class="page-header">
            <section class="page-header__container">
                <header>
                    <h1 class="page-header__heading--style"><%-$t('help_centre_1')%></h1>
                </header>
                <div class="page-header__description"><%-$t('help_centre_2')%></div>
            </section>
        </article>
        <article class="page-header__menu-container">
          <%- include('./_menu.ejs', { current: 'help-resources-fsa-migration-help' }) %>
        </article>
        <article class="page-content-container solid-h-container">
            <div class="page-content">
                <div class="page-section ui-card-list grid-section">
					<a id="fsa_migration_help_1" class="h-card h-1" href="javascript:openLiveChat()">
						<span class="h-img"></span>
						<span class="h-title"><%-$t('card_help_center_text-1')%></span>
					</a>
					<div class="h-space s-1"></div>
					<a id="fsa_migration_help_2" class="h-card h-2" href="mailto:support@icmarkets.com" target="_self">
						<span class="h-img"></span>
						<span class="h-title"><%-$t('card_help_center_text-2')%></span>
					</a>
					<div class="h-space s-2"></div>
					<a id="fsa_migration_help_3" class="h-card h-3 show-callback-form-button" target="_self">
						<span class="h-img"></span>
						<span class="h-title"><%-$t('card_help_center_text-3')%></span>
					</a>
                </div>
            </div>
        </article>

        <article style="display:none;" class="page-content-container callback-form-container" v-if="subjectVal">
            <div class="page-content">
                <div class="page-section">
					<%- include('../_partials/components/contact-us-form', {
						formHeading: $t('help_centre_6'),
						formDesc: $t('help_centre_7'),
						departmentVal: 'Support',
						subjectVal: 'CALL BACK REQUEST'
					}); %>

					<% setI18nPrefix('pages.help-resources.fsa-migration-help') %>
				</div>
            </div>
        </article>

        <article class="page-content-container">
            <div class="page-content">
                <div class="page-section">
					<div class="faq-block">
						<div class="faq-block__search">
							<h1 class="faq-block__header"><%-$t('fsa_faq_title')%></h1>
							<div class="faq-search__container">
								<input class="faq-input faq-search-input" type="text" placeholder="<%-$t('fsa_faq_input_placeholder', true)%>">
								<div class="faq-result"></div>
								<div class="faq-tips">
									<p>
										<b><%-$t('fsa_faq_tips_title')%></b><br>
										<%-$t('fsa_faq_tips_1')%><br>
										<%-$t('fsa_faq_tips_2')%>
									</p>
								</div>
							</div>
						</div>
						<!--
						WEB-1168
						we need to hide some sections of the following page (fsa-migration-help page)
						<div class="faq-section faq-section-1">
							<h1><%-$t('fsa_faq_section_1')%></h1>
							<% helpCentre.getSectionFAQs(1).forEach(item => { %>
								<div class="faq-block__item" key="<%=item.id%>">
									<div class="faq-accordion">
										<div class="accordion-toggle collapsed faq-block__expand-button" data-toggle="collapse" data-parent="#accordion" data-target="<%=item.ip%>"><%-item.q%></div>
										<div id="<%=item.id%>" class="panel-collapse collapse">
											<div class="panel-content"><%-item.a%></div>
										</div>
									</div>
								</div>
							<%})%>
						</div>
						-->
						<div class="faq-section faq-section-2">
							<h1><%-$t('fsa_faq_section_2')%></h1>
							<% helpCentre.getSectionFAQs(2).forEach(item => { %>
								<div class="faq-block__item" key="<%=item.id%>">
									<div class="faq-accordion">
										<div class="accordion-toggle collapsed faq-block__expand-button" data-toggle="collapse" data-parent="#accordion" data-target="<%=item.ip%>"><%-item.q%></div>
										<div id="<%=item.id%>" class="panel-collapse collapse">
												<div class="panel-content"><%-item.a%></div>
										</div>
									</div>
								</div>
							<%})%>
						</div>

						<div class="faq-section faq-section-3">
							<h1><%-$t('fsa_faq_section_3')%></h1>
							<% helpCentre.getSectionFAQs(3).forEach(item => { %>
								<div class="faq-block__item" key="<%=item.id%>">
									<div class="faq-accordion">
										<div class="accordion-toggle collapsed faq-block__expand-button" data-toggle="collapse" data-parent="#accordion" data-target="<%=item.ip%>"><%-item.q%></div>
										<div id="<%=item.id%>" class="panel-collapse collapse">
											<div class="panel-content"><%-item.a%></div>
										</div>
									</div>
								</div>
							<%})%>
						</div>
						<!--
						WEB-1168
						we need to hide some sections of the following page (fsa-migration-help page)
						<div class="faq-section faq-section-4">
							<h1><%-$t('fsa_faq_section_4')%></h1>
							<% helpCentre.getSectionFAQs(4).forEach(item => { %>
								<div class="faq-block__item" key="<%=item.id%>">
									<div class="faq-accordion">
										<div class="accordion-toggle collapsed faq-block__expand-button" data-toggle="collapse" data-parent="#accordion" data-target="<%=item.ip%>"><%-item.q%></div>
										<div id="<%=item.id%>" class="panel-collapse collapse">
											<div class="panel-content"><%-item.a%></div>
										</div>
									</div>
								</div>
							<%})%>
						</div>

						<div class="faq-section faq-section-5">
							<h1><%-$t('fsa_faq_section_5')%></h1>
							<% helpCentre.getSectionFAQs(5).forEach(item => { %>
								<div class="faq-block__item" key="<%=item.id%>">
									<div class="faq-accordion">
										<div class="accordion-toggle collapsed faq-block__expand-button" data-toggle="collapse" data-parent="#accordion" data-target="<%=item.ip%>"><%-item.q%></div>
										<div id="<%=item.id%>" class="panel-collapse collapse">
											<div class="panel-content"><%-item.a%></div>
										</div>
									</div>
								</div>
							<%})%>
						</div>
						-->
					</div>
                </div>
            </div>
        </article>

        <article class="page-content-container">
            <div class="page-content global-markets-today">
                <div class="page-section">
                    <div class="start-trading"><%-$t('help_centre_8')%></div>
                    <div class="global-today"><%-$t('help_centre_9a')%></div>
                    <div class="icm-button-wrapper page-header__primary-button">
						<a id="fsa_migration_help_4" class="icm-btn live icm-btn-primary" href="<%= localePath('open-trading-account-live')%>"><%-$t('help_centre_10')%></a>
						<a id="fsa_migration_help_5" class="icm-btn demo" href="<%= localePath('open-trading-account-demo')%>"><%-$t('help_centre_11')%></a>
                    </div>
                    <div data-t="help_centre_faq_1" style="display:none; opacity:0; visibility:hidden;"><%-$t('help_centre_faq_1', true)%></div>
                    <div data-t="help_centre_faq_2" style="display:none; opacity:0; visibility:hidden;"><%-$t('help_centre_faq_2', true)%></div>
                    <div data-t="help_centre_faq_3" style="display:none; opacity:0; visibility:hidden;"><%-$t('help_centre_faq_3', true)%></div>
                </div>
            </div>
        </article>
	</div>

<style>
  	.faq-reaction {
  		display: flex;
  		margin-top: 30px;
  		justify-content: flex-end;
  		font-style: italic;
  		font-size: 12px;
  		line-height: 1.5;
  	}
  	.faq-reaction-text {
  		padding-top: 18px;
  		margin-right: 10px;
  	}
  	.faq-reaction-btn {
  		display: inline-block;
  		margin-left: 20px;
  		opacity: 0.3;
  		width: 30px;
  		height: 30px;
  		cursor: pointer;
  		transition: all 0.33s ease;
  	}
  	.faq-reaction-btn.faq-reaction-happy:hover {
  		opacity: 0.7;
  		transition: all 0.33s ease;
  	}
  	.faq-reaction-btn.faq-reaction-angry:hover {
  		opacity: 0.7;
  		transition: all 0.33s ease;
  	}
  	.faq-reaction-happy {
  		background-image: url('data:image/svg+xml;utf8,<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="thumbs-up" class="svg-inline--fa fa-thumbs-up fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="green" d="M104 224H24c-13.255 0-24 10.745-24 24v240c0 13.255 10.745 24 24 24h80c13.255 0 24-10.745 24-24V248c0-13.255-10.745-24-24-24zM64 472c-13.255 0-24-10.745-24-24s10.745-24 24-24 24 10.745 24 24-10.745 24-24 24zM384 81.452c0 42.416-25.97 66.208-33.277 94.548h101.723c33.397 0 59.397 27.746 59.553 58.098.084 17.938-7.546 37.249-19.439 49.197l-.11.11c9.836 23.337 8.237 56.037-9.308 79.469 8.681 25.895-.069 57.704-16.382 74.757 4.298 17.598 2.244 32.575-6.148 44.632C440.202 511.587 389.616 512 346.839 512l-2.845-.001c-48.287-.017-87.806-17.598-119.56-31.725-15.957-7.099-36.821-15.887-52.651-16.178-6.54-.12-11.783-5.457-11.783-11.998v-213.77c0-3.2 1.282-6.271 3.558-8.521 39.614-39.144 56.648-80.587 89.117-113.111 14.804-14.832 20.188-37.236 25.393-58.902C282.515 39.293 291.817 0 312 0c24 0 72 8 72 81.452z"></path></svg>');
  	}
  	.faq-reaction-angry {
  		background-image: url('data:image/svg+xml;utf8,<svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="thumbs-down" class="svg-inline--fa fa-thumbs-down fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="red" d="M0 56v240c0 13.255 10.745 24 24 24h80c13.255 0 24-10.745 24-24V56c0-13.255-10.745-24-24-24H24C10.745 32 0 42.745 0 56zm40 200c0-13.255 10.745-24 24-24s24 10.745 24 24-10.745 24-24 24-24-10.745-24-24zm272 256c-20.183 0-29.485-39.293-33.931-57.795-5.206-21.666-10.589-44.07-25.393-58.902-32.469-32.524-49.503-73.967-89.117-113.111a11.98 11.98 0 0 1-3.558-8.521V59.901c0-6.541 5.243-11.878 11.783-11.998 15.831-.29 36.694-9.079 52.651-16.178C256.189 17.598 295.709.017 343.995 0h2.844c42.777 0 93.363.413 113.774 29.737 8.392 12.057 10.446 27.034 6.148 44.632 16.312 17.053 25.063 48.863 16.382 74.757 17.544 23.432 19.143 56.132 9.308 79.469l.11.11c11.893 11.949 19.523 31.259 19.439 49.197-.156 30.352-26.157 58.098-59.553 58.098H350.723C358.03 364.34 384 388.132 384 430.548 384 504 336 512 312 512z"></path></svg>');
  	}
</style>

<script>
    var helpCentre = {
        searchDB: [],
        searchResultByInput: '',
        searchHelpTips: false,
        handleSearchInput: function (e) {
            if (this.inputTimeout) clearTimeout(this.inputTimeout);

            let value = '';
            if (e.currentTarget) {
                value = e.currentTarget.value;
            }
            if (e.length && !e.currentTarget) {
                value = e.val();
            }
            this.inputTimeout = setTimeout(function () {
                let val = value;
                if (val) {
                    this.searchResultByInput = val;
                    this.searchHelpTips = false;
                    this.searchDB = this.getFiltered(val);
                } else {
                    this.searchResultByInput = '';
                    this.searchHelpTips = true;
                    this.searchDB = [];
                }
                this.updateSearchView();
            }.bind(this), 500);
        },
        getFiltered: function (text) {
			text = text || '~~~~~~~~~~';
			text = text.toLowerCase();
			var res = [];
			var matches = text.split(' ');
			var filtered = this.faqDB.filter(function (rec) {
				var h = document.createElement('DIV');
				h.innerHTML = rec.a;
				var t = h.textContent;
				var raw = (rec.q + ' ' + t).toLowerCase();
				var contain = true;
				for (var i in matches) {
					var m = matches[i];
					if (raw.indexOf(m) === -1) {
						contain = false;
						break;
					}
				}
				if (contain) {
					return true;
				} else {
					return false;
				}
			});
			if (filtered && filtered.length) {
                var len = filtered.length;
                res = [];
                if (len > 5) {
                    res = filtered.slice(0, 5);
                } else {
                    res = filtered;
                }
            }
            return res;
        },
        updateSearchView: function () {
            if (!this.$container) { this.$container = $('.faq-search__container'); }
            if (!this.$result) { this.$result = this.$container.find('.faq-result'); }
            if (!this.$tips) { this.$tips = this.$container.find('.faq-tips'); }

            if (this.searchHelpTips) {
                this.$tips.show();
            } else {
                this.$tips.hide();
            }

			      this.$result.html('');
            var text1 = $('div[data-t="help_centre_faq_1"]').html();
            var text2 = $('div[data-t="help_centre_faq_2"]').html();
            var text3 = $('div[data-t="help_centre_faq_3"]').html();
            var i, item, $record;
            if (this.searchDB.length) {
                for (i in this.searchDB) {
                    item = this.searchDB[i];
                    $record = $('' +
						'<div class="faq-block__item" key="' + item.id + '">' +
							'<div class="faq-accordion">' +
								'<div class="faq-block__expand-button">' + item.q + '</div>' +
								'<div class="panel-collapse collapse in">' +
									'<div class="panel-content">' +
										'<div>' + item.a + '</div>' +
										'<div class="faq-reaction">' +
											'<div class="faq-reaction-text">' + text1 + '</div>' +
											'<div><span class="faq-reaction-btn faq-reaction-happy"></span>&nbsp;<span>' + text2 + '</span></div>' +
											'<div><a id="fsa_migration_help_6"href="javascript:openLiveChat()" class="faq-reaction-btn faq-reaction-angry"></a>&nbsp;<span>' + text3 + '</span></div>' +
										'</div>' +
									'</div>' +
								'</div>' +
							'</div>' +
						'</div>'
                    );
                    $record.appendTo(this.$result);
                }
                // store "search" and "foundAnswersIds"
				        var search = $('.faq-input.faq-search-input').val();
				        var foundAnswersIds = this.searchDB.map(function (a) {return a.id;});
				        saveFaqSearch(search, foundAnswersIds);
            }
        },
        faqDB: <%- JSON.stringify(helpCentre.faqDB) %>
    };

    var regServiceURL = '<%= config.reg_service_1_url %>';
	function getSignToken () {
		var $def = $.Deferred();
		$.get(regServiceURL + '~get~sign~token~?nocache=' + Date.now()).done(function (token) {
			$def.resolve(token);
		}).fail(function () {
			$def.resolve(null);
		});
		return $def.promise();
	}
	function saveFaqSearch (search, foundAnswersIds) {
		if (!search) return;
		foundAnswersIds = foundAnswersIds ? foundAnswersIds : [];
		getSignToken().then(function(token) {
			$.ajax({
				dataType: "json",
				url: regServiceURL + "?saveFsaFaqSearch&search=" + encodeURIComponent(search) + "&found_answers_ids=" + encodeURIComponent(JSON.stringify(foundAnswersIds)) + "&sign=" + token,
				success: function (data) {
					console.log('saveFsaFaqSearch: success', data);
				},
				fail: function (err) {
					console.error('saveFsaFaqSearch: fail', err);
				}
			});
		});
	}
	function saveFaqReaction (search, answer_id, reaction) {
		if (!search || !answer_id || !reaction) return;
		getSignToken().then(function(token) {
			$.ajax({
				dataType: "json",
				url: regServiceURL + "?saveFsaFaqReaction&search=" + encodeURIComponent(search) + "&answer_id=" + answer_id + "&reaction=" + reaction + "&sign=" + token,
				success: function (data) {
					console.log('saveFsaFaqReaction: success', data);
				},
				fail: function (err) {
					console.error('saveFsaFaqReaction: fail', err);
				}
			});
		});
	}

    $(document).ready(function () {
		$('input.faq-search-input').on('input', helpCentre.handleSearchInput.bind(helpCentre));
		$('.show-callback-form-button').on('click', function () {
			if ($('.callback-form-container').is(':visible')) {
				$('.callback-form-container').hide();
			} else {
				$('.callback-form-container').show();
			}
		});
    $('.page-help-centre').on('click', '.faq-reaction-happy', function () {
			// store user positive reaction
			var search = $('.faq-input.faq-search-input').val();
			var answer_id = $(this).closest('.faq-block__item').attr('key');
			var reaction = 1;
			saveFaqReaction(search, answer_id, reaction);
			$(this).closest('.faq-reaction').fadeOut();
		});
		$('.page-help-centre').on('click', '.faq-reaction-angry', function () {
			// store user negative reaction
			var search = $('.faq-input.faq-search-input').val();
			var answer_id = $(this).closest('.faq-block__item').attr('key');
			var reaction = 0;
			saveFaqReaction(search, answer_id, reaction);
			$(this).closest('.faq-reaction').fadeOut();
		});
		<% if (typeof urlQuery != 'undefined') { %>
			var q = '<%- JSON.stringify(urlQuery) %>';
			var searchQuery = JSON.parse(q);
			if (searchQuery && searchQuery.search) {
				$('input.faq-search-input').val(decodeURIComponent(searchQuery.search));
				helpCentre.handleSearchInput($('input.faq-search-input'));
				$('.faq-block').closest('.page-content-container')[0].scrollIntoView();
			}
		<% } %>
    });
</script>
